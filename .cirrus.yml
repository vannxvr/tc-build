env:
  TZ: Asia/Jakarta
  ghuser_name: ENCRYPTED[!c65a010c8e7f3dc3dfcc7e64c145c759e3b0834e26a4b7b33b967e84c41845766a94ed4ca23c864461064d1efd361111!]
  ghuser_email: ENCRYPTED[!e720cfd7308c38f6ed0d236c421f822754b816904f0e965fd9628e96dde27fa7491fac1da4bfb4300d31da29a3289f98!]
  GITHUB_TOKEN: ENCRYPTED[!b4ce2ba3c7de73dd795afcd6b948f7f08e171d4715225db7e3531fcad5333787d4ba06556336a5e3a2ffd4741fc1ca60!]
  llvm_url: https://github.com/llvm/llvm-project

container:
  image: mhmmdfdlyas/dockerfile:t-ubuntu
  cpu: 8
  memory: 32G

cloning_task:
  name: Cloning Project (llvm source)
  skip: "!changesInclude('build-datestamp')"
  timeout_in: 120m
  only_if: $CIRRUS_BRANCH == 'main'
  script:
    - git clone --single-branch "${llvm_url}" -b main src/llvm-project --depth=1
  profdata_cache:
    folder: src/llvm-project
    fingerprint_key: $CIRRUS_BUILD_ID

profile_task:
  depends_on:
    - 'Cloning Project (llvm source)'
  name: Build LLVM (profile)
  skip: "!changesInclude('build-datestamp')"
  timeout_in: 120m
  only_if: $CIRRUS_BRANCH == 'main'
  profdata_cache:
    folder: build/llvm/instrumented
    folder: src/llvm-project
    fingerprint_key: $CIRRUS_BUILD_ID
  script:
    - ./tc_scripts/init.sh profile
    - find build/llvm/instrumented -type f ! -name 'profdata.prof' -delete

final_task:
  depends_on:
    - 'Build LLVM (profile)'
  name: Build LLVM (final)
  skip: "!changesInclude('build-datestamp')"
  timeout_in: 120m
  only_if: $CIRRUS_BRANCH == 'main'
  profdata_cache:
    folder: build/llvm/instrumented
    folder: src/llvm-project
    fingerprint_key: $CIRRUS_BUILD_ID
  script:
    - ./tc_scripts/init.sh final
